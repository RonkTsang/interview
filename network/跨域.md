# è·¨åŸŸ

- [è·¨åŸŸ](#%E8%B7%A8%E5%9F%9F)
  - [è·¨åŸŸï¼Œäº†è§£ä¸‹](#%E8%B7%A8%E5%9F%9F%EF%BC%8C%E4%BA%86%E8%A7%A3%E4%B8%8B)
  - [`CORS`](#cors)
    - [ç®€å•è¯·æ±‚](#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82)
    - [éç®€å•è¯·æ±‚](#%E9%9D%9E%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82)
  - [`JSONP`](#jsonp)
  - [å…¶ä»–è·¨åŸŸ](#%E5%85%B6%E4%BB%96%E8%B7%A8%E5%9F%9F)
  - [å‚è€ƒ](#%E5%8F%82%E8%80%83)

---
## è·¨åŸŸï¼Œäº†è§£ä¸‹

  > **è·¨åŸŸ(Cross-Origin)** æ˜¯æŒ‡åœ¨æµè§ˆå™¨çš„åŒæºç­–ç•¥ä¸‹, å½“å‰å®¢æˆ·ç«¯æ— æ³•è®¿é—®ä¸è‡ªèº«**ä¸åŒåè®®**( protocol), **ä¸åŒåŸŸå**(domain), **ä¸åŒç«¯å£å·**(port)çš„èµ„æº, ä¸‰è€…å‡ºç°å…¶ä¸­ä¸€ä¸ªä¸åŒ, å³è·¨åŸŸ.

  | A                           | B                            | è¯´æ˜                                                                  |
  | --------------------------- | ---------------------------- | --------------------------------------------------------------------- |
  | http://www.a.com/a.js       | http://www.a.com/b.js        | åŒä¸€åŸŸåä¸‹    å…è®¸                                                    |
  | http://www.a.com/lab/a.js   | http://www.a.com/script/b.js | åŒä¸€åŸŸåä¸‹ä¸åŒæ–‡ä»¶å¤¹ å…è®¸                                             |
  | http://www.a.com:8000/a.js  | http://www.a.com/b.js        | åŒä¸€åŸŸåï¼Œä¸åŒç«¯å£  ä¸å…è®¸                                            |
  | http://www.a.com/a.js       | https://www.a.com/b.js       | åŒä¸€åŸŸåï¼Œä¸åŒåè®® ä¸å…è®¸                                             |
  | http://www.a.com/a.js       | http://70.32.92.74/b.js      | åŸŸåå’ŒåŸŸåå¯¹åº”ip ä¸å…è®¸                                               |
  | http://www.a.com/a.js       | http://script.a.com/b.js     | ä¸»åŸŸç›¸åŒï¼Œå­åŸŸä¸åŒ ä¸å…è®¸                                             |
  | http://www.a.com/a.js       | http://a.com/b.js            | åŒä¸€åŸŸåï¼Œä¸åŒäºŒçº§åŸŸåï¼ˆåŒä¸Šï¼‰ ä¸å…è®¸ï¼ˆcookieè¿™ç§æƒ…å†µä¸‹ä¹Ÿä¸å…è®¸è®¿é—®ï¼‰ |
  | http://www.cnblogs.com/a.js | http://www.a.com/b.js        | ä¸åŒåŸŸå ä¸å…è®¸                                                       |

---

## `CORS`

  > CORS æ˜¯ä¸€ä¸ªW3Cæ ‡å‡†ï¼Œå…¨ç§°æ˜¯"è·¨åŸŸèµ„æºå…±äº«"ï¼ˆCross-origin resource sharingï¼‰ã€‚
  >
  > å®ƒå…è®¸æµè§ˆå™¨å‘è·¨æºæœåŠ¡å™¨ï¼Œå‘å‡º `XMLHttpRequest` è¯·æ±‚ï¼Œä»è€Œå…‹æœäº† `AJAX` åªèƒ½åŒæºä½¿ç”¨çš„é™åˆ¶ã€‚

  æµè§ˆå™¨å°†CORSè¯·æ±‚åˆ†æˆä¸¤ç±»ï¼š**ç®€å•è¯·æ±‚**ï¼ˆsimple requestï¼‰å’Œ**éç®€å•è¯·æ±‚**ï¼ˆnot-so-simple requestï¼‰ã€‚
  
 ### ç®€å•è¯·æ±‚
  
  åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äºç®€å•è¯·æ±‚

  - è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€
    - HEAD
    - GET
    - POST
  - HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µ
    - Accept
    - Accept-Language
    - Content-Language
    - Last-Event-ID
    - Content-Typeï¼šåªé™äºä¸‰ä¸ªå€¼`application/x-www-form-urlencoded`ã€`multipart/form-data`ã€`text/plain`

  æµç¨‹ï¼š
   
   å¯¹äºç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ç›´æ¥å‘å‡ºCORSè¯·æ±‚ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œå¢åŠ ä¸€ä¸ª `Origin` å­—æ®µã€‚
   
   ``` javascript
    GET /cors HTTP/1.1
    Origin: http://api.bob.com    ğŸ‘ˆ
    Host: api.alice.com
    Accept-Language: en-US
    Connection: keep-alive
    User-Agent: Mozilla/5.0...
   ```
   `Origin`å­—æ®µçš„ä½œç”¨å°±æ˜¯ç”¨æ¥è¯´æ˜ï¼Œ**æœ¬æ¬¡è¯·æ±‚æ¥è‡ªå“ªä¸ªæºï¼ˆåè®® + åŸŸå + ç«¯å£ï¼‰**ã€‚æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå€¼ï¼Œå†³å®šæ˜¯å¦åŒæ„è¿™æ¬¡è¯·æ±‚ã€‚

   - å¦‚æœ `Origin` æŒ‡å®šçš„æºï¼Œä¸åœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„ HTTP å›åº”ã€‚æµè§ˆå™¨å‘ç°ï¼Œè¿™ä¸ªå›åº”çš„å¤´ä¿¡æ¯æ²¡æœ‰åŒ…å« `Access-Control-Allow-Origin` å­—æ®µï¼Œå°±çŸ¥é“å‡ºé”™äº†ï¼Œä»è€ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¢« `XMLHttpRequest` çš„ `onerror` å›è°ƒå‡½æ•°æ•è·
   - å¦‚æœ `Origin` æŒ‡å®šçš„åŸŸååœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”ï¼Œä¼šå¤šå‡ºå‡ ä¸ªå¤´ä¿¡æ¯å­—æ®µ
   ``` javascript
    Access-Control-Allow-Origin: http://api.bob.com
    Access-Control-Allow-Credentials: true
    Access-Control-Expose-Headers: FooBar
    Content-Type: text/html; charset=utf-8
   ```
   å…³äºä¸Šé¢çš„ Headerï¼š

  - Access-Control-Allow-Origin

    è¯¥å­—æ®µæ˜¯**å¿…é¡»**çš„ã€‚å®ƒçš„å€¼è¦ä¹ˆæ˜¯è¯·æ±‚æ—¶ Origin å­—æ®µçš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª * ï¼Œè¡¨ç¤ºæ¥å—ä»»æ„åŸŸåçš„è¯·æ±‚ã€‚
  - Access-Control-Allow-Credentials

    è¯¥å­—æ®µ**å¯é€‰**ã€‚å®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸å‘é€Cookieã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCookieä¸åŒ…æ‹¬åœ¨CORSè¯·æ±‚ä¹‹ä¸­ã€‚è®¾ä¸º `true` ï¼Œå³è¡¨ç¤ºæœåŠ¡å™¨æ˜ç¡®è®¸å¯ï¼ŒCookieå¯ä»¥åŒ…å«åœ¨è¯·æ±‚ä¸­ï¼Œä¸€èµ·å‘ç»™æœåŠ¡å™¨ã€‚è¿™ä¸ªå€¼ä¹Ÿåªèƒ½è®¾ä¸º `true` ï¼Œå¦‚æœæœåŠ¡å™¨ä¸è¦æµè§ˆå™¨å‘é€Cookieï¼Œåˆ é™¤è¯¥å­—æ®µå³å¯ã€‚

    çœ‹è¿™é‡Œ ğŸ‘‰ [XMLHttpRequest ä¸­çš„ withCredential](../JS/XMLHttpRequest.md)
    
  - Access-Control-Expose-Headers

    è¯¥å­—æ®µå¯é€‰ã€‚CORS è¯·æ±‚æ—¶ï¼Œ`XMLHttpRequest` å¯¹è±¡çš„ `getResponseHeader()` æ–¹æ³•åªèƒ½æ‹¿åˆ°6ä¸ªåŸºæœ¬å­—æ®µï¼š`Cache-Control`ã€`Content-Language`ã€`Content-Type`ã€`Expires`ã€`Last-Modified`ã€`Pragma`ã€‚å¦‚æœæƒ³æ‹¿åˆ°å…¶ä»–å­—æ®µï¼Œå°±å¿…é¡»åœ¨ `Access-Control-Expose-Headers` é‡Œé¢æŒ‡å®šã€‚ä¸Šé¢çš„ä¾‹å­æŒ‡å®šï¼Œ `getResponseHeader('FooBar')` å¯ä»¥è¿”å› `FooBar` å­—æ®µçš„å€¼ã€‚

 ### éç®€å•è¯·æ±‚

  éç®€å•è¯·æ±‚æ˜¯é‚£ç§å¯¹æœåŠ¡å™¨æœ‰**ç‰¹æ®Šè¦æ±‚**çš„è¯·æ±‚ï¼Œæ¯”å¦‚è¯·æ±‚æ–¹æ³•æ˜¯ `PUT` æˆ– `DELETE` ï¼Œæˆ–è€… `Content-Type` å­—æ®µçš„ç±»å‹æ˜¯ `application/json` ã€‚

  éç®€å•è¯·æ±‚çš„CORSè¯·æ±‚ï¼Œä¼šåœ¨æ­£å¼é€šä¿¡ä¹‹å‰ï¼Œ**å¢åŠ ä¸€æ¬¡HTTPæŸ¥è¯¢è¯·æ±‚ï¼Œç§°ä¸º"é¢„æ£€"è¯·æ±‚ï¼ˆpreflightï¼‰**ã€‚

  å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼šæµè§ˆå™¨**å…ˆè¯¢é—®æœåŠ¡å™¨**ï¼Œå½“å‰ç½‘é¡µæ‰€åœ¨çš„åŸŸåæ˜¯å¦åœ¨æœåŠ¡å™¨çš„è®¸å¯åå•ä¹‹ä¸­ï¼Œä»¥åŠå¯ä»¥ä½¿ç”¨å“ªäº› HTTP åŠ¨è¯å’Œå¤´ä¿¡æ¯å­—æ®µã€‚åªæœ‰å¾—åˆ°è‚¯å®šç­”å¤ï¼Œæµè§ˆå™¨æ‰ä¼šå‘å‡ºæ­£å¼çš„ `XMLHttpRequest` è¯·æ±‚ï¼Œå¦åˆ™å°±æŠ¥é”™.

  "é¢„æ£€"è¯·æ±‚çš„HTTPå¤´ä¿¡æ¯:

  ``` javascript
  OPTIONS /cors HTTP/1.1
  Origin: http://api.bob.com
  Access-Control-Request-Method: PUT
  Access-Control-Request-Headers: X-Custom-Header
  Host: api.alice.com
  ```

  "é¢„æ£€" è¯·æ±‚ç”¨çš„è¯·æ±‚æ–¹æ³•æ˜¯ `OPTIONS` ï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ç”¨æ¥è¯¢é—®çš„ã€‚å¤´ä¿¡æ¯é‡Œé¢ï¼Œå…³é”®å­—æ®µæ˜¯ `Origin` ï¼Œè¡¨ç¤ºè¯·æ±‚æ¥è‡ªå“ªä¸ªæºã€‚

  é™¤äº† `Origin` å­—æ®µï¼Œ"é¢„æ£€"è¯·æ±‚çš„å¤´ä¿¡æ¯åŒ…æ‹¬ä¸¤ä¸ªç‰¹æ®Šå­—æ®µ

  - Access-Control-Request-Method
  
    è¯¥å­—æ®µæ˜¯**å¿…é¡»**çš„ï¼Œç”¨æ¥åˆ—å‡ºæµè§ˆå™¨çš„CORSè¯·æ±‚ä¼šç”¨åˆ°å“ªäº›HTTPæ–¹æ³•ï¼Œä¸Šä¾‹æ˜¯PUT

  - Access-Control-Request-Headers

    è¯¥å­—æ®µæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šæµè§ˆå™¨CORSè¯·æ±‚ä¼šé¢å¤–å‘é€çš„å¤´ä¿¡æ¯å­—æ®µï¼Œä¸Šä¾‹æ˜¯ `X-Custom-Header`
  
  **é¢„æ£€è¯·æ±‚çš„å›åº”**

  æœåŠ¡å™¨æ”¶åˆ°"é¢„æ£€"è¯·æ±‚ä»¥åï¼Œæ£€æŸ¥äº†`Origin`ã€`Access-Control-Request-Method` å’Œ `Access-Control-Request-Headers` å­—æ®µä»¥åï¼Œç¡®è®¤å…è®¸è·¨æºè¯·æ±‚ï¼Œå°±å¯ä»¥åšå‡ºå›åº”ã€‚

  ``` javascript
  HTTP/1.1 200 OK
  Access-Control-Allow-Origin: http://api.bob.com
  Access-Control-Allow-Methods: GET, POST, PUT
  Access-Control-Allow-Headers: X-Custom-Header
  Access-Control-Allow-Credentials: true
  Access-Control-Max-Age: 1728000
  ```

  - Access-Control-Allow-Origin

    è¡¨ç¤ºhttp://api.bob.comå¯ä»¥è¯·æ±‚æ•°æ®ã€‚è¯¥å­—æ®µä¹Ÿå¯ä»¥è®¾ä¸ºæ˜Ÿå·ï¼Œè¡¨ç¤ºåŒæ„ä»»æ„è·¨æºè¯·æ±‚
  - Access-Control-Allow-Methods

    è¯¥å­—æ®µå¿…éœ€ï¼Œå®ƒçš„å€¼æ˜¯é€—å·åˆ†éš”çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰è·¨åŸŸè¯·æ±‚çš„æ–¹æ³•ã€‚æ³¨æ„ï¼Œè¿”å›çš„æ˜¯æ‰€æœ‰æ”¯æŒçš„æ–¹æ³•ï¼Œè€Œä¸å•æ˜¯æµè§ˆå™¨è¯·æ±‚çš„é‚£ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ä¸ºäº†é¿å…å¤šæ¬¡"é¢„æ£€"è¯·æ±‚ã€‚

  - Access-Control-Allow-Headers

    å¦‚æœæµè§ˆå™¨è¯·æ±‚åŒ…æ‹¬Access-Control-Request-Headerså­—æ®µï¼Œåˆ™Access-Control-Allow-Headerså­—æ®µæ˜¯å¿…éœ€çš„ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µï¼Œä¸é™äºæµè§ˆå™¨åœ¨"é¢„æ£€"ä¸­è¯·æ±‚çš„å­—æ®µã€‚

  - Access-Control-Allow-Credentials

  - Access-Control-Max-Age

    è¯¥å­—æ®µå¯é€‰ï¼Œç”¨æ¥æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸ

  **æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº”**

  ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡äº†"é¢„æ£€"è¯·æ±‚ï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨æ­£å¸¸çš„CORSè¯·æ±‚ï¼Œå°±éƒ½**è·Ÿç®€å•è¯·æ±‚ä¸€æ ·**ï¼Œä¼šæœ‰ä¸€ä¸ª `Origin` å¤´ä¿¡æ¯å­—æ®µã€‚æœåŠ¡å™¨çš„å›åº”ï¼Œä¹Ÿéƒ½ä¼šæœ‰ä¸€ä¸ª `Access-Control-Allow-Origin` å¤´ä¿¡æ¯å­—æ®µã€‚

---

## `JSONP`

  > `JSONP` æ˜¯ç”¨æ¥è§£å†³è·¨åŸŸè¯·æ±‚çš„ï¼Œå®ƒå…è®¸ç”¨æˆ·ä¼ é€’ä¸€ä¸ª `callback` ç»™æœåŠ¡å™¨ç«¯ï¼Œç„¶åæœåŠ¡ç«¯è¿”å›æ•°æ®æ—¶ä¼šå°†è¿™ä¸ª `callback` ä½œä¸ºå‡½æ•°åæ¥åŒ…è£¹ä½ `JSON` æ•°æ®ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±å¯ä»¥éšæ„å®šåˆ¶è‡ªå·±çš„å‡½æ•°æ¥è‡ªåŠ¨å¤„ç†è¿”å›æ•°æ®äº†
  > 
  > **å‡¡æ˜¯æ‹¥æœ‰ `src` å±æ€§çš„æ ‡ç­¾éƒ½å¯ä»¥è·¨åŸŸ**ï¼Œ`JSONP` é çš„ä¹Ÿæ˜¯è¿™ä¸ªï¼Œæˆ‘ä»¬ç”¨ `<script>` æ¥å®ç° `JSONP`
  
  å®¢æˆ·ç«¯ï¼š
  ``` javascript
  <script type="text/javascript">
    function handler(json){
      console.log(json.name + ' ' + json.purpose);
    }
  </script>
  <script type="text/javascript" src="http://localhost:3030/?callback=handler"></script>
  ```

  æœåŠ¡å™¨ç«¯ï¼š

  ``` javascript
  var data  = {'name': 'a'};
  //æ ¸å¿ƒä»£ç 
  var str = callback + '(' + JSON.stringify(data) + ')'; //callbackæ˜¯æœåŠ¡å™¨ä»å®¢æˆ·ç«¯çš„è¯·æ±‚å‚æ•°é‡Œé¢è´§æ¸ é“çš„callbackçš„å€¼(å³handlerå‡½æ•°)
  res.end(str); //æœåŠ¡å™¨ç«¯è¿”å›handler(data)
  ```

  å¥½å¤„å°±æ˜¯ï¼šç®€å•ç²—æš´ ğŸ‘

  ç¼ºç‚¹å°±æ˜¯ï¼š
  - å…¶ä»–åŸŸä¸å®‰å…¨,å®¹æ˜“è¢«æ”»å‡»æˆ–è€…ç¯¡æ”¹,å¸¦æ¥å®‰å…¨é—®é¢˜
  - åªæ”¯æŒGETè¯·æ±‚.

---
## å…¶ä»–è·¨åŸŸ

- `window.name`
- `document.domain`
- `location.hash`
- `window.postMessage`

--- 
## å‚è€ƒ

[è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£](http://www.ruanyifeng.com/blog/2016/04/cors.html)